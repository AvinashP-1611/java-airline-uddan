<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Command Center - Udaan</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --sidebar-width: 280px;
            --primary: #3b82f6;
            --dark: #0f172a;
            --sidebar-bg: #1e293b;
            --bg-body: #f1f5f9;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: #334155;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        #sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--sidebar-bg);
            color: white;
            transition: all 0.3s;
            z-index: 1000;
            padding: 2rem 1rem;
        }

        .nav-link-admin {
            color: #94a3b8;
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            text-decoration: none;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .nav-link-admin:hover,
        .nav-link-admin.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        .nav-link-admin i {
            font-size: 1.25rem;
            margin-right: 1rem;
        }

        /* Main Content */
        #main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            transition: all 0.3s;
        }

        /* Cards and Stats */
        .admin-card {
            background: white;
            border: none;
            border-radius: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }

        .stat-badge {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* Tables */
        .table thead {
            background: #f8fafc;
        }

        .table th {
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            border: none;
            padding: 1rem;
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-color: #f1f5f9;
        }

        /* Buttons */
        .btn-admin {
            border-radius: 12px;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
        }

        /* Custom Badges */
        .pill-badge {
            border-radius: 50px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Media Queries */
        @media (max-width: 991.98px) {
            #sidebar {
                left: -var(--sidebar-width);
            }

            #sidebar.show {
                left: 0;
            }

            #main-content {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>

    <!-- Toggle Sidebar Button (Mobile) -->
    <button class="btn btn-primary d-lg-none position-fixed bottom-0 end-0 m-4 z-3 rounded-circle"
        onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <nav id="sidebar">
        <div class="mb-5 px-3">
            <h4 class="fw-bold mb-0 d-flex align-items-center">
                <span class="text-primary me-2">✈️</span> Udaan <small class="ms-2 fs-6 opacity-50">Admin</small>
            </h4>
        </div>

        <div class="nav flex-column">
            <a href="#" class="nav-link-admin active" onclick="showSection('flights')">
                <i class="bi bi-airplane"></i> Flights
            </a>
            <a href="#" class="nav-link-admin" onclick="showSection('airlines')">
                <i class="bi bi-building"></i> Airlines
            </a>
            <a href="#" class="nav-link-admin" onclick="showSection('cities')">
                <i class="bi bi-geo-alt"></i> Cities
            </a>
            <a href="#" class="nav-link-admin" onclick="showSection('users')">
                <i class="bi bi-people"></i> Users
            </a>
            <a href="#" class="nav-link-admin" onclick="showSection('bookings')">
                <i class="bi bi-ticket-perforated"></i> Bookings
            </a>
            <div class="mt-auto pt-5">
                <hr class="opacity-10">
                <a href="index.html" class="nav-link-admin text-danger" onclick="localStorage.clear()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Header -->
        <header class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1" id="section-title">Flight Management</h2>
                <p class="text-muted small mb-0" id="section-desc">Monitor and manage all flight operations</p>
            </div>
            <div id="action-header">
                <!-- Dynamic Action Button -->
            </div>
        </header>

        <!-- Stats Row -->
        <div class="row g-4 mb-5" id="stats-row">
            <!-- Dynamic Stats injected by JS -->
        </div>

        <!-- Section Containers -->
        <div id="flights-section" class="section-container">
            <div class="admin-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Flight No</th>
                                <th>Airline</th>
                                <th>Route</th>
                                <th>Capacity</th>
                                <th>Prices (E/B)</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="flightsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="airlines-section" class="section-container" style="display:none;">
            <div class="admin-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Airline Name</th>
                                <th>Total Flights</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="airlinesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="cities-section" class="section-container" style="display:none;">
            <div class="admin-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>City Name</th>
                                <th>Code</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="citiesTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="users-section" class="section-container" style="display:none;">
            <div class="admin-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="bookings-section" class="section-container" style="display:none;">
            <div class="admin-card">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Flight</th>
                                <th>Route</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookingsTableBody"></tbody>
                    </table>
                </div>
                <!-- Global Booking Pagination -->
                <div class="p-3 bg-light border-top">
                    <nav aria-label="Booking pagination">
                        <ul class="pagination pagination-sm justify-content-center mb-0" id="booking-pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals (Generic Container) -->
    <div id="modal-container">
        <!-- Add Flight Modal -->
        <div class="modal fade" id="addFlightModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content shadow-lg">
                    <div class="modal-header border-0 pb-0">
                        <h5 class="modal-title fw-bold">Register New Flight</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="addFlightForm" class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Flight Number</label>
                                <input type="text" id="f_num" class="form-control rounded-3" placeholder="Fetching..."
                                    readonly required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Airline</label>
                                <select id="f_airline_select" class="form-select rounded-3" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Origin City</label>
                                <select id="f_origin_select" class="form-select rounded-3" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Destination City</label>
                                <select id="f_dest_select" class="form-select rounded-3" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Economy Seats</label>
                                <input type="number" id="f_eco_total" class="form-control rounded-3" value="180"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Business Seats</label>
                                <input type="number" id="f_bus_total" class="form-control rounded-3" value="20"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Economy Price (₹)</label>
                                <input type="number" id="f_eco_price" class="form-control rounded-3" placeholder="5000"
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">Business Price (₹)</label>
                                <input type="number" id="f_bus_price" class="form-control rounded-3" placeholder="15000"
                                    required>
                            </div>
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-primary w-100 btn-admin">Create Flight</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Airline Modal -->
        <div class="modal fade" id="addAirlineModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold">Create Airline Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="addAirlineForm">
                            <div class="mb-4">
                                <label class="form-label small fw-bold">Airline Name</label>
                                <input type="text" id="a_name" class="form-control rounded-3" placeholder="e.g. Vistara"
                                    required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-admin">Create Airline</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add City Modal -->
        <div class="modal fade" id="addCityModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold">Add New Destination</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="addCityForm">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">City Name</label>
                                <input type="text" id="c_name" class="form-control rounded-3" placeholder="New Delhi"
                                    required>
                            </div>
                            <div class="mb-4">
                                <label class="form-label small fw-bold">IATA Code</label>
                                <input type="text" id="c_code" class="form-control rounded-3" placeholder="DEL"
                                    maxlength="3" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-admin">Add City</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div class="modal fade" id="addUserModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title fw-bold">Register New User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="addUserForm">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Username</label>
                                <input type="text" id="u_username" class="form-control rounded-3" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Password</label>
                                <input type="password" id="u_password" class="form-control rounded-3" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Role</label>
                                <select id="u_role" class="form-select rounded-3" required>
                                    <option value="USER">Regular User</option>
                                    <option value="AIRLINE">Airline Manager</option>
                                    <option value="ADMIN">System Admin</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Full Name</label>
                                <input type="text" id="u_fullname" class="form-control rounded-3" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Email</label>
                                <input type="email" id="u_email" class="form-control rounded-3" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 btn-admin mt-3">Register User</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="adminToast" class="toast align-items-center border-0 text-white" role="alert">
            <div class="d-flex">
                <div class="toast-body" id="toastMsg"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:9090/api';
        const AUTH_HEADER = localStorage.getItem('auth');
        if (!AUTH_HEADER) window.location.href = 'login.html';

        const toast = new bootstrap.Toast(document.getElementById('adminToast'));
        function showMsg(m, success = true) {
            document.getElementById('toastMsg').innerText = m;
            document.getElementById('adminToast').className = `toast align-items-center border-0 text-white ${success ? 'bg-success' : 'bg-danger'}`;
            toast.show();
        }

        // Section Navigation
        function showSection(id) {
            document.querySelectorAll('.section-container').forEach(s => s.style.display = 'none');
            document.getElementById(id + '-section').style.display = 'block';

            document.querySelectorAll('.nav-link-admin').forEach(l => l.classList.remove('active'));
            event?.currentTarget?.classList?.add('active');

            const titles = {
                flights: ['Flight Management', 'Monitor and manage all flight operations'],
                airlines: ['Airline Management', 'Manage airline partners and ownership'],
                cities: ['City Management', 'Configure destinations and airport codes'],
                users: ['User Management', 'View and manage system users'],
                bookings: ['Booking Overview', 'Consolidated view of all transaction records']
            };

            document.getElementById('section-title').innerText = titles[id][0];
            document.getElementById('section-desc').innerText = titles[id][1];
            updateActionHeader(id);
            refreshData(id);
        }

        function updateActionHeader(id) {
            const container = document.getElementById('action-header');
            container.innerHTML = '';
            if (id === 'flights') container.innerHTML = '<button class="btn btn-primary btn-admin" data-bs-toggle="modal" data-bs-target="#addFlightModal" onclick="fetchNextFlightNumber()"><i class="bi bi-plus-lg me-2"></i>New Flight</button>';
            if (id === 'airlines') container.innerHTML = '<button class="btn btn-primary btn-admin" data-bs-toggle="modal" data-bs-target="#addAirlineModal"><i class="bi bi-plus-lg me-2"></i>Add Airline</button>';
            if (id === 'cities') container.innerHTML = '<button class="btn btn-primary btn-admin" data-bs-toggle="modal" data-bs-target="#addCityModal"><i class="bi bi-plus-lg me-2"></i>Add City</button>';
            if (id === 'users') container.innerHTML = '<button class="btn btn-primary btn-admin" data-bs-toggle="modal" data-bs-target="#addUserModal"><i class="bi bi-person-plus me-2"></i>New User</button>';
        }

        async function fetchNextFlightNumber() {
            try {
                const res = await fetch(`${API_BASE}/admin/flights/next-number`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } });
                const nextNum = await res.text();
                document.getElementById('f_num').value = nextNum;
            } catch (err) { console.error('Error fetching next flight number:', err); }
        }

        function refreshData(id) {
            if (id === 'flights') loadFlights();
            if (id === 'airlines') loadAirlines();
            if (id === 'cities') loadCities();
            if (id === 'users') loadUsers();
            if (id === 'bookings') loadAllBookings();
        }

        // Data Loaders
        async function loadFlights() {
            try {
                const res = await fetch(`${API_BASE}/admin/flights`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } });
                const data = await res.json();
                const tbody = document.getElementById('flightsTableBody');
                tbody.innerHTML = data.map(f => `
                    <tr>
                        <td><div class="fw-bold">${f.flightNumber}</div></td>
                        <td><span class="pill-badge bg-primary bg-opacity-10 text-primary">${f.airlineName}</span></td>
                        <td>${f.origin.split(' ')[0]} ➝ ${f.destination.split(' ')[0]}</td>
                        <td>
                            <div class="small text-muted">E: ${f.economySeatsTotal} | B: ${f.businessSeatsTotal}</div>
                        </td>
                        <td>
                            <div class="fw-bold">₹${f.economyPrice} / ₹${f.businessPrice}</div>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light border-0" onclick="deleteItem('flights', ${f.id})"><i class="bi bi-trash text-danger"></i></button>
                        </td>
                    </tr>
                `).join('');
                updateStats('flights', data.length);
            } catch (err) { console.error(err); }
        }

        async function loadAirlines() {
            try {
                const [airlinesRes, flightsRes, usersRes] = await Promise.all([
                    fetch(`${API_BASE}/public/airlines`),
                    fetch(`${API_BASE}/admin/flights`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } }),
                    fetch(`${API_BASE}/admin/users`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } })
                ]);

                const airlines = await airlinesRes.json();
                const flights = await flightsRes.json();
                const users = await usersRes.json();

                document.getElementById('airlinesTableBody').innerHTML = airlines.map(a => {
                    const flightCount = flights.filter(f => f.airlineName === a.name).length;
                    const owner = users.find(u => u.airlineName === a.name && u.role === 'AIRLINE');

                    return `
                        <tr>
                            <td class="fw-bold">${a.name}</td>
                            <td><span class="badge bg-primary bg-opacity-10 text-primary">${flightCount} Flights</span></td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-light border-0" onclick="deleteItem('airlines', ${a.id})"><i class="bi bi-trash text-danger"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
                updateStats('airlines', airlines.length);
            } catch (err) { console.error(err); }
        }

        async function loadCities() {
            try {
                const res = await fetch(`${API_BASE}/public/cities`);
                const data = await res.json();
                document.getElementById('citiesTableBody').innerHTML = data.map(c => `
                    <tr>
                        <td class="fw-bold">${c.name}</td>
                        <td><code class="bg-light px-2 rounded-2">${c.code}</code></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light border-0" onclick="deleteItem('cities', ${c.id})"><i class="bi bi-trash text-danger"></i></button>
                        </td>
                    </tr>
                `).join('');
                updateStats('cities', data.length);
            } catch (err) { console.error(err); }
        }

        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/admin/users`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } });
                const data = await res.json();
                document.getElementById('usersTableBody').innerHTML = data.map(u => `
                    <tr>
                        <td class="fw-bold">${u.username}</td>
                        <td><span class="pill-badge ${u.role === 'ADMIN' ? 'bg-danger' : (u.role === 'AIRLINE' ? 'bg-warning text-dark' : 'bg-success')} bg-opacity-10">${u.role}</span></td>
                        <td>${u.email || 'N/A'}</td>
                        <td>${u.phone || 'N/A'}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-light border-0" onclick="deleteItem('users', ${u.id})"><i class="bi bi-trash text-danger"></i></button>
                        </td>
                    </tr>
                `).join('');
                updateStats('users', data.length);
            } catch (err) { console.error(err); }
        }

        async function loadAllBookings(page = 0) {
            try {
                const res = await fetch(`${API_BASE}/admin/bookings?page=${page}&size=10`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } });
                const data = await res.json();
                document.getElementById('bookingsTableBody').innerHTML = data.content.map(b => `
                    <tr>
                        <td class="font-monospace small">#${b.id}</td>
                        <td>${b.user ? b.user.username : 'N/A'}</td>
                        <td><span class="badge bg-light text-dark border">${b.flight ? b.flight.flightNumber : 'N/A'}</span></td>
                        <td class="small">${b.flight ? b.flight.origin.split(' ')[0] + ' ➝ ' + b.flight.destination.split(' ')[0] : 'N/A'}</td>
                        <td class="fw-bold text-success">₹${(b.totalPrice || 0).toLocaleString()}</td>
                        <td><span class="pill-badge bg-${b.status === 'CONFIRMED' ? 'success' : 'danger'} bg-opacity-10 text-${b.status === 'CONFIRMED' ? 'success' : 'danger'}">${b.status}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary border-0" onclick="viewBookingDetails(${b.id})">
                                <i class="bi bi-eye"></i> Details
                            </button>
                        </td>
                    </tr>
                `).join('');
                renderBookingPagination(data.totalPages, page);
                updateStats('bookings', data.totalElements);
            } catch (err) { console.error(err); }
        }

        async function viewBookingDetails(id) {
            try {
                const res = await fetch(`${API_BASE}/bookings/${id}`, { headers: { 'Authorization': 'Basic ' + AUTH_HEADER } });
                const b = await res.json();

                const modalHtml = `
                    <div class="modal fade" id="detailsModal" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg">
                                <div class="modal-header bg-primary text-white border-0 py-4">
                                    <h5 class="modal-title fw-bold">Booking Details #${b.id}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <div class="row g-4">
                                        <div class="col-md-6">
                                            <label class="text-muted small text-uppercase fw-bold mb-2">Flight Information</label>
                                            <div class="p-3 bg-light rounded-3">
                                                <div class="fw-bold text-dark fs-5 mb-1">${b.flight ? b.flight.airlineName : 'N/A'} - ${b.flight ? b.flight.flightNumber : 'N/A'}</div>
                                                <div class="text-primary fw-bold mb-2">${b.flight ? b.flight.origin : 'N/A'} ➝ ${b.flight ? b.flight.destination : 'N/A'}</div>
                                                <div class="badge bg-white text-dark border px-3 py-2 shadow-sm">${b.flightClass} CLASS</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="text-muted small text-uppercase fw-bold mb-2">Customer & Payment</label>
                                            <div class="p-3 bg-light rounded-3">
                                                <div class="fw-bold text-dark mb-1">${b.user ? b.user.username : 'N/A'}</div>
                                                <div class="text-muted small mb-2">${b.user ? b.user.email : ''}</div>
                                                <div class="text-success fw-bold fs-5">Total Paid: ₹${(b.totalPrice || 0).toLocaleString()}</div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label class="text-muted small text-uppercase fw-bold mb-2">Passenger Manifest (${b.passengers ? b.passengers.length : 0})</label>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th class="border-0">Full Name</th>
                                                            <th class="border-0">Age</th>
                                                            <th class="border-0">Gender</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${b.passengers ? b.passengers.map(p => `
                                                            <tr>
                                                                <td>${p.fullName}</td>
                                                                <td>${p.age}</td>
                                                                <td><span class="badge bg-secondary bg-opacity-10 text-secondary">${p.gender}</span></td>
                                                            </tr>
                                                        `).join('') : '<tr><td colspan="3">No passengers found</td></tr>'}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Remove old modal if exists
                const old = document.getElementById('detailsModal');
                if (old) old.remove();

                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('detailsModal')).show();
            } catch (err) { console.error(err); }
        }

        function renderBookingPagination(totalPages, currentPage) {
            const pag = document.getElementById('booking-pagination');
            let html = `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}"><a class="page-link border-0" href="#" onclick="loadAllBookings(${currentPage - 1})">Prev</a></li>`;
            for (let i = 0; i < totalPages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link shadow-none" href="#" onclick="loadAllBookings(${i})">${i + 1}</a></li>`;
            }
            html += `<li class="page-item ${currentPage === totalPages - 1 || totalPages === 0 ? 'disabled' : ''}"><a class="page-link border-0" href="#" onclick="loadAllBookings(${currentPage + 1})">Next</a></li>`;
            pag.innerHTML = html;
        }

        function updateStats(type, count) {
            const statsRow = document.getElementById('stats-row');
            const icons = { flights: 'airplane', airlines: 'building', cities: 'geo-alt', users: 'people', bookings: 'ticket-perforated' };
            const colors = { flights: 'primary', airlines: 'warning', cities: 'info', users: 'success', bookings: 'danger' };

            // Only update if current section matches type or first load
            const activeType = document.querySelector('.nav-link-admin.active').innerText.trim().toLowerCase();
            if (activeType.includes(type)) {
                statsRow.innerHTML = `
                    <div class="col-md-3">
                        <div class="admin-card p-4 d-flex align-items-center">
                            <div class="stat-badge bg-${colors[type]} bg-opacity-10 text-${colors[type]} me-3">
                                <i class="bi bi-${icons[type]}"></i>
                            </div>
                            <div>
                                <h6 class="text-muted small fw-bold text-uppercase mb-1">Total ${type}</h6>
                                <h3 class="mb-0 fw-bold">${count}</h3>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Logic for form submissions and deletions...
        document.getElementById('addFlightForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const flight = {
                flightNumber: document.getElementById('f_num').value,
                airlineName: document.getElementById('f_airline_select').value,
                origin: document.getElementById('f_origin_select').value,
                destination: document.getElementById('f_dest_select').value,
                economySeatsTotal: document.getElementById('f_eco_total').value,
                businessSeatsTotal: document.getElementById('f_bus_total').value,
                economyPrice: document.getElementById('f_eco_price').value,
                businessPrice: document.getElementById('f_bus_price').value
            };
            const res = await fetch(`${API_BASE}/admin/flights`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + AUTH_HEADER },
                body: JSON.stringify(flight)
            });
            if (res.ok) {
                showMsg('Flight registered successfully');
                bootstrap.Modal.getInstance(document.getElementById('addFlightModal')).hide();
                loadFlights();
            } else {
                showMsg('Error creating flight', false);
            }
        });

        document.getElementById('addAirlineForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const airline = {
                name: document.getElementById('a_name').value
            };
            const res = await fetch(`${API_BASE}/admin/airlines`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + AUTH_HEADER },
                body: JSON.stringify(airline)
            });
            if (res.ok) {
                showMsg('Airline account created');
                bootstrap.Modal.getInstance(document.getElementById('addAirlineModal')).hide();
                loadAirlines();
            } else {
                showMsg('Error creating airline', false);
            }
        });

        document.getElementById('addCityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const city = { name: document.getElementById('c_name').value, code: document.getElementById('c_code').value };
            const res = await fetch(`${API_BASE}/admin/cities`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + AUTH_HEADER },
                body: JSON.stringify(city)
            });
            if (res.ok) {
                showMsg('New destination added');
                bootstrap.Modal.getInstance(document.getElementById('addCityModal')).hide();
                loadCities();
            } else {
                showMsg('Error adding city', false);
            }
        });

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = {
                username: document.getElementById('u_username').value,
                password: document.getElementById('u_password').value,
                role: document.getElementById('u_role').value,
                fullName: document.getElementById('u_fullname').value,
                email: document.getElementById('u_email').value
            };
            const res = await fetch(`${API_BASE}/admin/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + AUTH_HEADER },
                body: JSON.stringify(user)
            });
            if (res.ok) {
                showMsg('User created successfully');
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                loadUsers();
            } else {
                const msg = await res.text();
                showMsg(msg || 'Error creating user', false);
            }
        });

        async function deleteItem(type, id) {
            if (!confirm(`Are you sure you want to delete this ${type.slice(0, -1)}?`)) return;
            const res = await fetch(`${API_BASE}/admin/${type}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Basic ' + AUTH_HEADER }
            });
            if (res.ok) {
                showMsg('Item deleted');
                refreshData(type);
            } else {
                const text = await res.text();
                showMsg(text || 'Delete failed', false);
            }
        }

        async function preloadDropdowns() {
            try {
                const [airlines, cities] = await Promise.all([
                    fetch(`${API_BASE}/public/airlines`).then(r => r.json()),
                    fetch(`${API_BASE}/public/cities`).then(r => r.json())
                ]);
                document.getElementById('f_airline_select').innerHTML = airlines.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
                document.getElementById('f_origin_select').innerHTML = cities.map(c => `<option value="${c.name}">${c.name} (${c.code})</option>`).join('');
                document.getElementById('f_dest_select').innerHTML = cities.map(c => `<option value="${c.name}">${c.name} (${c.code})</option>`).join('');
            } catch (err) { console.error(err); }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        // Initialize
        showSection('flights');
        preloadDropdowns();
    </script>
</body>

</html>