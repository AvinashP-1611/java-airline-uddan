<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Airline Dashboard - Udaan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 40px;
            background: #f4f7f6;
        }

        .dashboard-container {
            max-width: 1000px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <div class="header">
            <h2 class="fw-bold" id="dashboardTitle">Airline Dashboard</h2>
            <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
        </div>

        <h4 class="mb-3 text-muted">Manage Your Flight Schedules</h4>
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Flight No</th>
                    <th>Origin</th>
                    <th>Destination</th>
                    <th>Economy Details</th>
                    <th>Business Details</th>
                    <th>Departure</th>
                    <th>Arrival</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="flightsTableBody"></tbody>
        </table>

        <div class="mt-5">
            <h4 class="mb-3 text-muted">Recent Bookings on Your Flights</h4>
            <div class="table-responsive">
                <table class="table table-striped bg-white shadow-sm rounded">
                    <thead class="table-info">
                        <tr>
                            <th>Ref ID</th>
                            <th>User Details</th>
                            <th>Flight</th>
                            <th>Class</th>
                            <th>Passenger Details</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTableBody"></tbody>
                </table>
            </div>

            <!-- Booking Pagination -->
            <div class="d-flex justify-content-center mt-3">
                <nav aria-label="Booking pagination">
                    <ul class="pagination pagination-sm" id="booking-pagination">
                        <!-- Pagination buttons -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div class="modal fade" id="editScheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Flight Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_f_id">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Departure Time</label>
                        <input type="datetime-local" id="edit_f_dep" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Arrival Time</label>
                        <input type="datetime-local" id="edit_f_arr" class="form-control">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Economy Price</label>
                            <input type="number" id="edit_f_eco" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Business Price</label>
                            <input type="number" id="edit_f_bus" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSchedule()">Update Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:9090/api';
        const AUTH_HEADER = localStorage.getItem('auth');
        const AIRLINE_NAME = localStorage.getItem('airlineName');

        if (!AUTH_HEADER || !AIRLINE_NAME) window.location.href = 'login.html';

        document.getElementById('dashboardTitle').innerText = `${AIRLINE_NAME} Panel`;

        loadMyFlights();
        loadAirlineBookings();

        let bookingPage = 0;
        const bookingSize = 10;

        async function loadAirlineBookings(page = 0) {
            bookingPage = page;
            try {
                const res = await fetch(`${API_BASE}/airline/bookings?airlineName=${encodeURIComponent(AIRLINE_NAME)}&page=${page}&size=${bookingSize}`, {
                    headers: { 'Authorization': 'Basic ' + AUTH_HEADER }
                });
                const data = await res.json();
                const bookings = data.content || [];
                const totalPages = data.totalPages || 0;

                const tbody = document.getElementById('bookingsTableBody');
                tbody.innerHTML = bookings.map(b => `
                    <tr>
                        <td>#${b.id}</td>
                        <td>
                            <div class="fw-bold">${b.user ? b.user.username : 'N/A'}</div>
                            <small class="text-muted d-block">${b.user ? b.user.email : ''}</small>
                            <small class="text-muted d-block">${b.user ? b.user.phone || '' : ''}</small>
                        </td>
                        <td>${b.flight ? b.flight.flightNumber : 'N/A'}</td>
                        <td><span class="badge bg-secondary">${b.flightClass}</span></td>
                        <td>
                            <div class="small">
                                ${b.passengers ? b.passengers.map(p => `<div>${p.fullName} (${p.age}, ${p.gender})</div>`).join('') : 'N/A'}
                            </div>
                        </td>
                        <td><small class="fw-bold text-success">₹${b.totalPrice || 0}</small></td>
                        <td><span class="badge bg-${b.status === 'CONFIRMED' ? 'success' : 'danger'}">${b.status}</span></td>
                    </tr>
                `).join('');

                renderBookingPagination(totalPages, page);
            } catch (err) { console.error(err); }
        }

        function renderBookingPagination(totalPages, currentPage) {
            const pag = document.getElementById('booking-pagination');
            if (!pag) return;

            let html = `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadAirlineBookings(${currentPage - 1})">Previous</a>
                </li>
            `;
            for (let i = 0; i < totalPages; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadAirlineBookings(${i})">${i + 1}</a>
                    </li>
                `;
            }
            html += `
                <li class="page-item ${currentPage === totalPages - 1 || totalPages === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="loadAirlineBookings(${currentPage + 1})">Next</a>
                </li>
            `;
            pag.innerHTML = html;
        }

        async function loadMyFlights() {
            const res = await fetch(`${API_BASE}/airline/flights?airlineName=${encodeURIComponent(AIRLINE_NAME)}`, {
                headers: { 'Authorization': 'Basic ' + AUTH_HEADER }
            });
            const flights = await res.json();
            const tbody = document.getElementById('flightsTableBody');
            tbody.innerHTML = flights.map(f => `
                <tr>
                    <td class="fw-bold">${f.flightNumber}</td>
                    <td>${f.origin}</td>
                    <td>${f.destination}</td>
                    <td>${f.economySeatsAvailable}/${f.economySeatsTotal} | ₹${f.economyPrice}</td>
                    <td>${f.businessSeatsAvailable}/${f.businessSeatsTotal} | ₹${f.businessPrice}</td>
                    <td>${f.departureTime ? f.departureTime.replace('T', ' ') : '<span class="text-danger">NOT SET</span>'}</td>
                    <td>${f.arrivalTime ? f.arrivalTime.replace('T', ' ') : '<span class="text-danger">NOT SET</span>'}</td>
                    <td><button class="btn btn-sm btn-primary" onclick='openEditModal(${JSON.stringify(f)})'>Edit Schedule</button></td>
                </tr>
            `).join('');
        }

        function openEditModal(f) {
            document.getElementById('edit_f_id').value = f.id;
            document.getElementById('edit_f_dep').value = f.departureTime ? f.departureTime.slice(0, 16) : '';
            document.getElementById('edit_f_arr').value = f.arrivalTime ? f.arrivalTime.slice(0, 16) : '';
            document.getElementById('edit_f_eco').value = f.economyPrice || '';
            document.getElementById('edit_f_bus').value = f.businessPrice || '';
            new bootstrap.Modal(document.getElementById('editScheduleModal')).show();
        }

        async function saveSchedule() {
            const id = document.getElementById('edit_f_id').value;
            const schedule = {
                departureTime: document.getElementById('edit_f_dep').value,
                arrivalTime: document.getElementById('edit_f_arr').value,
                economyPrice: document.getElementById('edit_f_eco').value,
                businessPrice: document.getElementById('edit_f_bus').value
            };
            const res = await fetch(`${API_BASE}/airline/flights/${id}/schedule`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + AUTH_HEADER },
                body: JSON.stringify(schedule)
            });
            if (res.ok) {
                alert('Schedule updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editScheduleModal')).hide();
                loadMyFlights();
            } else {
                alert('Failed to update schedule.');
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        loadMyFlights();
    </script>
</body>

</html>