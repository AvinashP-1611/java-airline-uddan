<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveler Dashboard - Udaan</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --accent: #f59e0b;
            --bg-body: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: #1e293b;
        }

        /* Modern Navbar */
        .navbar {
            background-color: #0f172a !important;
            padding: 1rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-link {
            font-weight: 500;
            padding: 0.5rem 1rem !important;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Dashboard Container */
        .dashboard-container {
            padding-top: 2rem;
            padding-bottom: 5rem;
        }

        /* Search Card */
        .search-card {
            background: var(--glass-bg);
            border: none;
            border-radius: 24px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-card-header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 1.5rem 2rem;
        }

        /* Date Bar */
        .date-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent !important;
        }

        .date-item:hover:not(.bg-primary) {
            background-color: #f1f5f9 !important;
            transform: translateY(-2px);
        }

        /* Flight Card */
        .flight-card {
            border: none;
            border-radius: 20px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .flight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .price-badge {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Modal Enhancements */
        .modal-content {
            border-radius: 24px;
            border: none;
        }

        .modal-header {
            background: #0f172a;
            color: white;
            border-radius: 24px 24px 0 0;
            padding: 1.5rem 2rem;
        }

        /* Custom Buttons */
        .btn-booking {
            border-radius: 12px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.2s;
        }

        .btn-booking:hover {
            transform: scale(1.02);
        }

        /* Wallet Styling */
        .wallet-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            border-radius: 24px;
            border: none;
        }

        /* Utility */
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark mb-4 sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <span class="me-2 text-primary">✈️</span> Udaan <span
                    class="ms-2 badge bg-primary fs-6 fw-normal">Traveler</span>
            </a>
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse"
                data-bs-target="#navDashboard">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navDashboard">
                <ul class="navbar-nav ms-auto gap-2">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('search')"><i
                                class="bi bi-search me-2"></i>Find Flights</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('bookings')"><i
                                class="bi bi-ticket-perforated me-2"></i>My Bookings</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showSection('wallet')"><i
                                class="bi bi-wallet2 me-2"></i>My Wallet</a></li>
                    <li class="nav-item ms-lg-3"><a class="nav-link text-danger fw-bold" href="index.html"
                            onclick="localStorage.clear()"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container dashboard-container">

        <!-- Search Section -->
        <div id="search-section">
            <div class="card search-card mb-5">
                <div class="search-card-header">
                    <h4 class="mb-0 fw-bold"><i class="bi bi-airplane-engines me-2"></i>Where to next?</h4>
                    <p class="mb-0 opacity-75 small">Book your next adventure in seconds</p>
                </div>
                <div class="card-body p-4 p-lg-5">
                    <form id="searchForm" class="row g-4">
                        <div class="col-md-5">
                            <label class="form-label small fw-bold text-muted text-uppercase">From</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i
                                        class="bi bi-geo-alt"></i></span>
                                <div id="origin-container" class="flex-grow-1">
                                    <input type="text" id="origin" class="form-control border-start-0"
                                        placeholder="Origin City" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label small fw-bold text-muted text-uppercase">To</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i
                                        class="bi bi-geo-fill"></i></span>
                                <div id="dest-container" class="flex-grow-1">
                                    <input type="text" id="destination" class="form-control border-start-0"
                                        placeholder="Destination City" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold shadow-sm"
                                style="border-radius: 12px;">
                                <i class="bi bi-search me-2"></i>Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Date Selection Bar -->
            <div class="mb-4">
                <div class="d-flex align-items-center gap-3">
                    <h5 class="mb-0 fw-bold text-muted small text-uppercase">Choose Date</h5>
                    <div class="flex-grow-1 border-bottom"></div>
                </div>
                <div class="d-flex align-items-center mt-3 gap-2">
                    <button class="btn btn-white shadow-sm rounded-circle border p-2" onclick="navigateDates(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div id="date-bar" class="d-flex flex-grow-1 justify-content-between gap-2 overflow-auto py-2">
                        <!-- Dates will be injected here -->
                    </div>
                    <button class="btn btn-white shadow-sm rounded-circle border p-2" onclick="navigateDates(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <div class="ms-lg-3">
                        <input type="date" id="directDatePicker" class="form-control shadow-sm border-0 bg-white"
                            onchange="jumpToDate(this.value)" style="border-radius: 12px; height: 48px;">
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="row g-4 mt-2">
                <div class="col-12 text-center py-5">
                    <img src="https://cdni.iconscout.com/illustration/premium/thumb/searching-for-flight-tickets-online-4461622-3714488.png"
                        alt="Search" style="max-width: 250px; opacity: 0.6;">
                    <p class="text-muted mt-4">Fill in your destination to see available flights.</p>
                </div>
            </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookings-section" style="display:none;">
            <h4 class="mb-3">My Bookings</h4>
            <div id="bookings-list" class="row">
                <!-- Data loaded via JS -->
            </div>

            <!-- Booking Pagination -->
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Booking pagination">
                    <ul class="pagination pagination-sm" id="booking-pagination">
                        <!-- Pagination buttons -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Wallet Section -->
        <div id="wallet-section" style="display:none;">
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 mb-4 bg-primary text-white">
                        <div class="card-body p-4 text-center">
                            <h5 class="card-title mb-3">Wallet Balance</h5>
                            <h2 class="display-5 fw-bold" id="wallet-balance">₹0.00</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card shadow-sm border-0">
                        <div class="card-body p-4">
                            <h4 class="mb-3">Transaction History</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Type</th>
                                            <th>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wallet-transactions">
                                        <!-- Transactions loaded via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Passenger Details Modal -->
    <div class="modal fade" id="passengerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content shadow border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold">Passenger Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Step Indicator -->
                    <div class="d-flex justify-content-center mb-4">
                        <div id="step1-indicator" class="badge rounded-pill bg-primary px-3 py-2 me-2">1. Passengers
                        </div>
                        <div id="step2-indicator" class="badge rounded-pill bg-light text-dark border px-3 py-2">2.
                            Payment</div>
                    </div>

                    <!-- Step 1: Passenger Details -->
                    <div id="step1-content">
                        <div id="passenger-container">
                            <!-- Dynamic Passenger Forms -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm mb-3" id="addPassengerBtn">
                            + Add Another Passenger
                        </button>
                        <div class="alert alert-info py-2 mb-0">
                            <small>Note: Maximum passengers allowed depends on seat availability.</small>
                        </div>
                    </div>

                    <!-- Step 2: Payment Details -->
                    <div id="step2-content" style="display:none;">
                        <h6 class="fw-bold mb-3 text-primary">Select Payment Method</h6>
                        <div class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="payCC"
                                    value="CREDIT_CARD" checked onchange="togglePaymentFields()">
                                <label class="form-check-label" for="payCC">Credit/Debit Card</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="payUPI"
                                    value="UPI" onchange="togglePaymentFields()">
                                <label class="form-check-label" for="payUPI">UPI</label>
                            </div>
                        </div>

                        <div id="cc-fields" class="payment-fields">
                            <div class="mb-3">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" id="cc_number"
                                    placeholder="1234 5678 9101 1121">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Expiry (MM/YY)</label>
                                    <input type="text" class="form-control" id="cc_expiry" placeholder="12/25">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">CVV</label>
                                    <input type="password" class="form-control" id="cc_cvv" placeholder="123">
                                </div>
                            </div>
                        </div>

                        <div id="upi-fields" class="payment-fields" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">UPI ID (VPA)</label>
                                <input type="text" class="form-control" id="upi_id" placeholder="username@upi">
                            </div>
                        </div>

                        <div class="mt-3 p-3 bg-light rounded shadow-sm border">
                            <h5 class="fw-bold text-success mb-0">Total Amount: ₹<span id="finalTotalPrice">0</span>
                            </h5>
                        </div>
                    </div>

                    <!-- Step 3: Success Celebration -->
                    <div id="success-content" style="display:none;" class="text-center py-5">
                        <div class="mb-4">
                            <i class="bi bi-patch-check-fill text-success" style="font-size: 5rem;"></i>
                        </div>
                        <h2 class="fw-bold text-success mb-3">Hurrah!</h2>
                        <h4 class="mb-4">Booking Successful!</h4>
                        <p class="text-muted">Redirecting you to My Bookings in 3 seconds...</p>
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary px-4" id="nextToPaymentBtn">Next: Payment</button>
                    <button type="button" class="btn btn-outline-secondary" id="backToPassengersBtn"
                        style="display:none;">Back</button>
                    <button type="button" class="btn btn-success px-4" id="confirmPaymentBtn"
                        style="display:none;">Confirm & Pay</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                Hello, world! This is a toast message.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:9090/api';
        const AUTH_HEADER = localStorage.getItem('auth');

        // Redirect to login if no auth found
        if (!AUTH_HEADER && !window.location.href.includes('index.html')) {
            window.location.href = 'login.html';
        }
        const toastEl = document.getElementById('liveToast');
        const toast = new bootstrap.Toast(toastEl);
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        function showToast(title, message, isSuccess) {
            toastTitle.innerText = title;
            toastMessage.innerText = message;
            if (isSuccess) {
                toastEl.classList.remove('text-bg-danger');
                toastEl.classList.add('text-bg-success');
            } else {
                toastEl.classList.remove('text-bg-success');
                toastEl.classList.add('text-bg-danger');
            }
            toast.show();
        }

        function showSection(section) {
            document.getElementById('search-section').style.display = section === 'search' ? 'block' : 'none';
            document.getElementById('bookings-section').style.display = section === 'bookings' ? 'block' : 'none';
            document.getElementById('wallet-section').style.display = section === 'wallet' ? 'block' : 'none';

            if (section === 'bookings') loadMyBookings(0);
            if (section === 'wallet') loadWallet();
        }

        async function loadWallet() {
            try {
                // Load Balance
                const balRes = await fetch(`${API_BASE}/user/wallet/balance`, {
                    headers: { 'Authorization': 'Basic ' + AUTH_HEADER }
                });
                const balData = await balRes.json();
                document.getElementById('wallet-balance').innerText = '₹' + (balData.balance || 0).toFixed(2);

                // Load Transactions
                const txnRes = await fetch(`${API_BASE}/user/wallet/transactions`, {
                    headers: { 'Authorization': 'Basic ' + AUTH_HEADER }
                });
                const txns = await txnRes.json();
                const tbody = document.getElementById('wallet-transactions');
                tbody.innerHTML = txns.map(t => `
                    <tr>
                        <td>${new Date(t.transactionTime).toLocaleString()}</td>
                        <td>${t.description}</td>
                        <td><span class="badge ${t.type === 'CREDIT' ? 'bg-success' : 'bg-danger'}">${t.type}</span></td>
                        <td class="${t.type === 'CREDIT' ? 'text-success' : 'text-danger'} fw-bold">
                            ${t.type === 'CREDIT' ? '+' : '-'}₹${t.amount.toFixed(2)}
                        </td>
                    </tr>
                `).join('');
                if (txns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No transactions found.</td></tr>';
                }
            } catch (err) { console.error(err); }
        }

        let selectedDate = new Date().toISOString().split('T')[0];
        let startDateOffset = 0;

        function updateDateBar() {
            const container = document.getElementById('date-bar');
            container.innerHTML = '';

            const today = new Date();
            for (let i = 0; i < 4; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + startDateOffset + i);
                const dateStr = date.toISOString().split('T')[0];
                const isActive = dateStr === selectedDate;

                const label = i === 0 && startDateOffset === 0 ? 'Today' :
                    date.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' });

                const div = document.createElement('div');
                div.className = `date-item flex-fill text-center p-2 rounded cursor-pointer ${isActive ? 'bg-primary text-white' : 'bg-white border text-dark'}`;
                div.style.cursor = 'pointer';
                div.innerHTML = `<small class="fw-bold">${label}</small>`;
                div.onclick = () => selectDate(dateStr);
                container.appendChild(div);
            }
            document.getElementById('directDatePicker').value = selectedDate;
        }

        function navigateDates(direction) {
            startDateOffset += direction;
            updateDateBar();
        }

        function selectDate(date) {
            selectedDate = date;
            updateDateBar();
            performSearch();
        }

        function jumpToDate(date) {
            selectedDate = date;
            // Adjust offset to show the jumped date if needed, or just let it be
            updateDateBar();
            performSearch();
        }

        document.getElementById('searchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            performSearch();
        });

        async function performSearch() {
            const origin = document.getElementById('origin').value;
            const dest = document.getElementById('destination').value;
            if (!origin || !dest) return;

            try {
                const res = await fetch(`${API_BASE}/public/flights/search?origin=${origin}&destination=${dest}&date=${selectedDate}`);
                const flights = await res.json();
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';

                if (flights.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="col-12">
                            <div class="card border-0 shadow-sm text-center py-5 rounded-4">
                                <div class="card-body">
                                    <i class="bi bi-info-circle display-4 text-warning mb-3"></i>
                                    <h5>No Flights Found</h5>
                                    <p class="text-muted">Sorry, we don't have any flights for this route on the selected date.</p>
                                </div>
                            </div>
                        </div>`;
                    return;
                }

                flights.forEach(f => {
                    resultsDiv.innerHTML += `
                        <div class="col-md-6">
                            <div class="card flight-card h-100">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div>
                                            <h5 class="fw-bold mb-0 text-primary">${f.airlineName}</h5>
                                            <small class="text-muted fw-bold">${f.flightNumber}</small>
                                        </div>
                                        <div class="text-end">
                                            <div class="price-badge mb-1">₹${f.economyPrice} <small class="text-muted fw-normal" style="font-size: 0.7rem;">(Economy)</small></div>
                                            <div class="text-secondary fw-bold" style="font-size: 0.9rem;">₹${f.businessPrice} <small class="text-muted fw-normal" style="font-size: 0.7rem;">(Business)</small></div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded-4 my-4">
                                        <div class="text-center">
                                            <div class="fw-bold fs-5">${f.origin.split(' ')[0]}</div>
                                            <small class="text-muted">${f.departureTime ? new Date(f.departureTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'TBA'}</small>
                                        </div>
                                        <div class="flex-grow-1 px-4 text-center position-relative">
                                            <hr class="border-primary border-dashed opacity-25">
                                            <i class="bi bi-airplane-fill text-primary position-absolute top-50 start-50 translate-middle bg-light px-2" style="font-size: 1.2rem;"></i>
                                        </div>
                                        <div class="text-center">
                                            <div class="fw-bold fs-5">${f.destination.split(' ')[0]}</div>
                                            <small class="text-muted">${f.arrivalTime ? new Date(f.arrivalTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'TBA'}</small>
                                        </div>
                                    </div>

                                    <div class="row g-2">
                                        <div class="col-6">
                                            <button class="btn btn-outline-primary btn-booking w-100" 
                                                onclick="bookFlight(${f.id}, 'ECONOMY', ${f.economyPrice})"
                                                ${f.economySeatsAvailable <= 0 ? 'disabled' : ''}>
                                                <small class="d-block text-uppercase" style="font-size: 0.6rem;">Book Economy</small>
                                                <span class="fs-6">${f.economySeatsAvailable} Left</span>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-primary btn-booking w-100 shadow-sm" 
                                                onclick="bookFlight(${f.id}, 'BUSINESS', ${f.businessPrice})"
                                                ${f.businessSeatsAvailable <= 0 ? 'disabled' : ''}>
                                                <small class="d-block text-uppercase text-white-50" style="font-size: 0.6rem;">Book Business</small>
                                                <span class="fs-6">${f.businessSeatsAvailable} Left</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top-0 px-4 pb-4">
                                    <small class="text-muted"><i class="bi bi-calendar3 me-2"></i>${new Date(selectedDate).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (err) { console.error(err); }
        }

        let currentBookingInfo = null;

        async function bookFlight(flightId, flightClass, price) {
            currentBookingInfo = { flightId, flightClass, basePrice: price };
            // Reset passenger container
            const container = document.getElementById('passenger-container');
            container.innerHTML = `
                <div class="passenger-form border rounded p-3 mb-3 bg-white shadow-sm position-relative">
                    <h6 class="fw-bold mb-3 text-primary">Passenger 1</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control p_name" placeholder="John Doe" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-control p_age" placeholder="25" required min="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Gender</label>
                            <select class="form-select p_gender" required>
                                <option value="">Select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;

            // Re-bind the add passenger button or just let the global function work
            // But let's check if the modal needs a fresh instance
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('passengerModal'));
            modal.show();

            // UI State Reset
            document.getElementById('step1-content').style.display = 'block';
            document.getElementById('step2-content').style.display = 'none';
            document.getElementById('nextToPaymentBtn').style.display = 'block';
            document.getElementById('confirmPaymentBtn').style.display = 'none';
            document.getElementById('backToPassengersBtn').style.display = 'none';
            document.getElementById('step1-indicator').className = 'badge rounded-pill bg-primary px-3 py-2 me-2';
            document.getElementById('step2-indicator').className = 'badge rounded-pill bg-light text-dark border px-3 py-2';
        }

        function togglePaymentFields() {
            const method = document.querySelector('input[name="paymentMethod"]:checked').value;
            document.getElementById('cc-fields').style.display = method === 'CREDIT_CARD' ? 'block' : 'none';
            document.getElementById('upi-fields').style.display = method === 'UPI' ? 'block' : 'none';
        }

        function addPassengerField() {
            const container = document.getElementById('passenger-container');
            const count = container.querySelectorAll('.passenger-form').length + 1;
            const div = document.createElement('div');
            div.className = 'passenger-form border rounded p-3 mb-3 bg-white shadow-sm position-relative';
            div.innerHTML = `
                <h6 class="fw-bold mb-3 text-primary">Passenger ${count}</h6>
                <button type="button" class="btn-close position-absolute top-0 end-0 m-2" style="font-size: 0.8rem;" onclick="this.parentElement.remove()"></button>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control p_name" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Age</label>
                        <input type="number" class="form-control p_age" required min="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Gender</label>
                        <select class="form-select p_gender" required>
                            <option value="">Select</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        document.getElementById('addPassengerBtn').addEventListener('click', addPassengerField);

        document.getElementById('nextToPaymentBtn').addEventListener('click', () => {
            const forms = document.querySelectorAll('.passenger-form');
            if (forms.length === 0) return alert('At least one passenger is required.');

            let isValid = true;
            forms.forEach(form => {
                if (!form.querySelector('.p_name').value || !form.querySelector('.p_age').value || !form.querySelector('.p_gender').value) {
                    isValid = false;
                }
            });

            if (!isValid) return alert('Please fill all passenger details.');

            // Calculate Price
            const totalPrice = currentBookingInfo.basePrice * forms.length;

            document.getElementById('finalTotalPrice').innerText = totalPrice;
            currentBookingInfo.totalPrice = totalPrice;

            // Switch Steps
            document.getElementById('step1-content').style.display = 'none';
            document.getElementById('step2-content').style.display = 'block';
            document.getElementById('nextToPaymentBtn').style.display = 'none';
            document.getElementById('confirmPaymentBtn').style.display = 'block';
            document.getElementById('backToPassengersBtn').style.display = 'block';
            document.getElementById('step1-indicator').className = 'badge rounded-pill bg-light text-dark border px-3 py-2 me-2';
            document.getElementById('step2-indicator').className = 'badge rounded-pill bg-primary px-3 py-2';
        });

        document.getElementById('backToPassengersBtn').addEventListener('click', () => {
            document.getElementById('step1-content').style.display = 'block';
            document.getElementById('step2-content').style.display = 'none';
            document.getElementById('nextToPaymentBtn').style.display = 'block';
            document.getElementById('confirmPaymentBtn').style.display = 'none';
            document.getElementById('backToPassengersBtn').style.display = 'none';
            document.getElementById('step1-indicator').className = 'badge rounded-pill bg-primary px-3 py-2 me-2';
            document.getElementById('step2-indicator').className = 'badge rounded-pill bg-light text-dark border px-3 py-2';
        });

        document.getElementById('confirmPaymentBtn').addEventListener('click', async () => {
            const passengers = [];
            const forms = document.querySelectorAll('.passenger-form');
            forms.forEach(form => {
                passengers.push({
                    fullName: form.querySelector('.p_name').value,
                    age: parseInt(form.querySelector('.p_age').value),
                    gender: form.querySelector('.p_gender').value
                });
            });

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            // Basic Simulation of Payment Gateway
            if (paymentMethod === 'CREDIT_CARD') {
                const num = document.getElementById('cc_number').value;
                const exp = document.getElementById('cc_expiry').value;
                const cvv = document.getElementById('cc_cvv').value;
                if (!num || !exp || !cvv) return alert('Please enter card details');
            } else {
                const upi = document.getElementById('upi_id').value;
                if (!upi) return alert('Please enter UPI ID');
            }

            try {
                const res = await fetch(`${API_BASE}/user/bookings/book`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + AUTH_HEADER
                    },
                    body: JSON.stringify({
                        flightId: currentBookingInfo.flightId,
                        flightClass: currentBookingInfo.flightClass,
                        passengers: passengers,
                        paymentMethod: paymentMethod,
                        totalPrice: currentBookingInfo.totalPrice
                    })
                });

                if (res.ok) {
                    // Show Success Content
                    document.getElementById('step2-content').style.display = 'none';
                    document.getElementById('step3-indicator')?.remove(); // Cleanup indicator if any
                    document.getElementById('success-content').style.display = 'block';

                    // Hide Footer Buttons
                    document.querySelector('.modal-footer').style.display = 'none';

                    // Trigger Confetti
                    const duration = 3 * 1000;
                    const end = Date.now() + duration;

                    (function frame() {
                        confetti({
                            particleCount: 7,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff']
                        });
                        confetti({
                            particleCount: 7,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: ['#26ccff', '#a25afd', '#ff5e7e', '#88ff5a', '#fcff42', '#ffa62d', '#ff36ff']
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());

                    // Delayed Navigation
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('passengerModal'));
                        modal.hide();
                        // Reset modal for next use
                        document.querySelector('.modal-footer').style.display = 'flex';
                        showSection('bookings');
                    }, 3000);
                } else {
                    const msg = await res.text();
                    showToast('Error', msg || 'Processing failed.', false);
                }
            } catch (err) {
                showToast('Error', 'Gateway connection error.', false);
            }
        });

        let bookingPage = 0;
        const bookingSize = 5;

        async function loadMyBookings(page = 0) {
            bookingPage = page;
            try {
                const res = await fetch(`${API_BASE}/user/bookings/my?page=${page}&size=${bookingSize}`, {
                    headers: { 'Authorization': 'Basic ' + AUTH_HEADER }
                });
                const data = await res.json();
                const bookings = data.content || [];
                const totalPages = data.totalPages || 0;

                const bookingsList = document.getElementById('bookings-list');
                bookingsList.innerHTML = '';

                if (bookings.length === 0) {
                    bookingsList.innerHTML = `
                        <div class="col-12 mt-3">
                            <div class="card shadow-sm border-0">
                                <div class="card-body text-center p-5">
                                    <p class="text-muted">You haven't booked any flights yet.</p>
                                    <button class="btn btn-primary" onclick="showSection('search')">Book a Flight</button>
                                </div>
                            </div>
                        </div>`;
                    document.getElementById('booking-pagination').innerHTML = '';
                    return;
                }

                // Pagination Buttons
                let pagHtml = `
                    <li class="page-item ${page === 0 ? 'disabled' : ''}">
                        <a class="page-item page-link" href="#" onclick="loadMyBookings(${page - 1})">Previous</a>
                    </li>
                `;
                for (let i = 0; i < totalPages; i++) {
                    pagHtml += `
                        <li class="page-item ${i === page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="loadMyBookings(${i})">${i + 1}</a>
                        </li>
                    `;
                }
                pagHtml += `
                    <li class="page-item ${page === totalPages - 1 || totalPages === 0 ? 'disabled' : ''}">
                        <a class="page-item page-link" href="#" onclick="loadMyBookings(${page + 1})">Next</a>
                    </li>
                `;
                document.getElementById('booking-pagination').innerHTML = pagHtml;

                bookings.forEach(b => {
                    const f = b.flight;
                    if (!f) {
                        bookingsList.innerHTML += `
                            <div class="col-md-12 mb-3">
                                <div class="card shadow-sm border-0 border-start border-danger border-4">
                                    <div class="card-body">
                                        <h5 class="text-danger">Flight Details Unavailable</h5>
                                        <p class="mb-0">Booking Ref: #${b.id} | Class: ${b.flightClass}</p>
                                    </div>
                                </div>
                            </div>`;
                        return;
                    }
                    const price = b.flightClass === 'BUSINESS' ? f.businessPrice : f.economyPrice;
                    bookingsList.innerHTML += `
                        <div class="col-md-12 mb-3">
                            <div class="card shadow-sm border-0 border-start border-primary border-4">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-1 text-primary">${f.airlineName} <small class="text-muted">(${f.flightNumber})</small></h5>
                                        <div class="mb-2"><small class="badge bg-light text-dark border">Booked by: ${b.user ? b.user.username : 'You'}</small></div>
                                        <p class="mb-0 fw-bold">${f.origin} ➝ ${f.destination} <span class="badge bg-secondary ms-2">${b.flightClass}</span></p>
                                        <small class="text-muted d-block">Departure: ${f.departureTime ? new Date(f.departureTime).toLocaleString() : 'TBA'}</small>
                                        <div class="mt-2 text-dark">
                                            <small class="fw-bold text-muted">Passengers:</small>
                                            <p class="mb-0 small">${b.passengers ? b.passengers.map(p => `${p.fullName} (${p.age}, ${p.gender})`).join(', ') : 'No passenger details'}</p>
                                        </div>
                                        <div class="mt-1">
                                            <span class="badge bg-light text-dark border"><small>${b.paymentMethod || 'CASH'} | ${b.transactionId || 'N/A'}</small></span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-${b.status === 'CONFIRMED' ? 'success' : 'danger'} mb-2">${b.status}</span>
                                        <p class="mb-0 fw-bold text-success">₹${b.totalPrice || (price * (b.passengers ? b.passengers.length : 1))}</p>
                                        <small class="text-muted">Ref: #${b.id}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } catch (err) { console.error(err); }
        }

        // Fetch cities for search if they were dropdowns (they are currently text inputs)
        // Let's convert them to dropdowns for better UX as per the city code requirement
        async function loadSearchCities() {
            try {
                const res = await fetch(`${API_BASE}/public/cities`);
                const cities = await res.json();
                const cityOptions = cities.map(c => `<option value="${c.name}">${c.name} (${c.code})</option>`).join('');
                document.getElementById('origin-container').innerHTML = `<select id="origin" class="form-select border-start-0" required><option value="">Select Origin</option>${cityOptions}</select>`;
                document.getElementById('dest-container').innerHTML = `<select id="destination" class="form-select border-start-0" required><option value="">Select Destination</option>${cityOptions}</select>`;
            } catch (err) { console.error(err); }
        }
        loadSearchCities();
        updateDateBar();
    </script>
</body>

</html>